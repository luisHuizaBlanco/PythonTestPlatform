<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Python Exercise #1</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 40px; }
  h1 { color: #333; }
  textarea { width: 100%; height: 180px; font-family: monospace; font-size: 14px; }
  button { background: #007bff; color: white; border: none; padding: 10px 16px; margin: 8px 4px; cursor: pointer; border-radius: 6px; }
  button:hover { background: #0056b3; }
  pre { background: #eee; padding: 8px; border-radius: 6px; }
  #output { margin-top: 20px; font-weight: bold; }
  #progress { margin-bottom: 10px; font-weight: bold; }
  #grade { margin-bottom: 10px; font-weight: bold; color: #007bff; }
  #challengeList { margin-bottom: 15px; }
  .challengeItem { display: inline-block; padding: 5px 10px; margin: 3px; border-radius: 6px; background: #ddd; cursor: pointer; }
  .challengeItem.active { background: #007bff; color: white; }
  .challengeItem.completed { background: #28a745; color: white; }
</style>
</head>
<body>

<h1>Python Exercise #1</h1>

<label>Student Name:
<input type="text" id="studentName" placeholder="Enter your name">
</label>

<h1 id="title">Challenge Title</h1>
<p id="description">Challenge description goes here.</p>

<div id="progress"></div>
<div id="grade"></div>
<div id="challengeList"></div>

<textarea id="code"></textarea><br>

<button onclick="runCode()">Run Tests</button>
<button onclick="prevChallenge()">◀ Previous</button>
<button onclick="nextChallenge()">Next ▶</button>
<button onclick="submitScore()">Submit Final Score</button>

<div id="output"></div>

<script>
let pyodideReady = loadPyodide();

const challenges = [
  { id:1, title:"Sum of Two Numbers", description:"Write a function <code>sum(a, b)</code> that returns the sum of two numbers.", starter:"def sum(a, b):\n    return a + b", functionName:"sum", tests:[ { input:[2,3], expected:5 }, { input:[-1,5], expected:4 } ] },
  { id:2, title:"Subtraction of Two Numbers", description:"Write a function <code>sub(a, b)</code> that returns the subtraction of two numbers.", starter:"def sub(a, b):\n    return a - b", functionName:"sub", tests:[ { input:[2,3], expected:-1 }, { input:[-1,5], expected:-6 } ] },
  { id:3, title:"Return the First Element", description:"Write a function <code>getFirst(arr)</code> that returns the first element of an array.", starter:"def getFirst(arr):\n    return arr[0]", functionName:"getFirst", tests:[ { input:[[1,2,3]], expected:1 }, { input:[[10,20,30]], expected:10 }, { input:[[5]], expected:5 } ] },
  { id:4, title:"Reverse a String", description:"Write a function <code>reverseString(str)</code> that returns the reversed string.", starter:"def reverseString(s):\n    return s[::-1]", functionName:"reverseString", tests:[ { input:["hello"], expected:"olleh" }, { input:["abc"], expected:"cba" }, { input:["!123"], expected:"321!" } ] }
];

let currentIndex=0;
let completed={};
let testResults={};
challenges.forEach(ch=>testResults[`cases_${ch.id}`]=new Array(ch.tests.length).fill(false));

function totalTests(){ return challenges.reduce((sum,ch)=>sum+ch.tests.length,0); }
function totalPassed(){ 
  return challenges.reduce((total,ch)=>{
    const arr = testResults[`cases_${ch.id}`];
    return total + arr.reduce((s,p)=>s+(p?1:0),0);
  },0);
}

function loadChallenge(index){
  const ch = challenges[index];
  document.getElementById("title").innerHTML = ch.title;
  document.getElementById("description").innerHTML = ch.description;
  document.getElementById("code").value = ch.starter;
  document.getElementById("output").innerHTML = "";
  updateProgress();
  renderChallengeList();
  showVisibleTests(ch);
}

function showVisibleTests(ch){
  const outputDiv=document.getElementById("output");
  let html=`<h3>Test Cases:</h3>`;
  ch.tests.forEach((t,i)=>{
    html+=`<pre>Test ${i+1}: Input: ${JSON.stringify(t.input)} | Expected: ${JSON.stringify(t.expected)}</pre>`;
  });
  outputDiv.innerHTML=html;
}

async function runCode(){
  const pyodide = await pyodideReady;
  const ch = challenges[currentIndex];
  const code = document.getElementById("code").value;
  const outputDiv = document.getElementById("output");
  outputDiv.innerHTML=`<h3>Test Results:</h3>`;

  let passedCount=0;
  let caseResults=[];

  try{
    await pyodide.runPythonAsync(code);
    for(let i=0;i<ch.tests.length;i++){
      const t = ch.tests[i];
      const args = t.input.map(v=>JSON.stringify(v)).join(", ");
      const result = pyodide.runPython(`${ch.functionName}(${args})`);
      const pass = result === t.expected;
      caseResults[i] = pass;
      if(pass) passedCount++;
      outputDiv.innerHTML += `<pre style="color:${pass?'green':'red'}">
        Test ${i+1}: ${t.input.join(', ')} ➜ ${result} (${pass?'✅ Passed':'❌ Expected '+t.expected})
      </pre>`;
    }

    testResults[ch.id] = passedCount;
    testResults[`cases_${ch.id}`] = caseResults;
    if(passedCount===ch.tests.length) completed[ch.id]=true; else delete completed[ch.id];

    outputDiv.innerHTML += `<p><strong>${passedCount} / ${ch.tests.length} tests passed.</strong></p>`;
    updateProgress();
    renderChallengeList();
  }catch(err){
    outputDiv.innerHTML=`<pre style="color:red;">${err}</pre>`;
  }
}

function nextChallenge(){ currentIndex=(currentIndex+1)%challenges.length; loadChallenge(currentIndex); }
function prevChallenge(){ currentIndex=(currentIndex-1+challenges.length)%challenges.length; loadChallenge(currentIndex); }

function updateProgress(){
  const doneCount = Object.keys(completed).length;
  const total = challenges.length;
  document.getElementById("progress").innerText=`Challenges Completed: ${doneCount} / ${total}`;
  document.getElementById("grade").innerText=`Total Grade: ${totalPassed()} / ${totalTests()} tests passed`;
}

function renderChallengeList(){
  const listDiv=document.getElementById("challengeList");
  listDiv.innerHTML="";
  challenges.forEach((ch,i)=>{
    const span=document.createElement("span");
    span.innerText=ch.title;
    span.className="challengeItem";
    if(i===currentIndex) span.classList.add("active");
    if(completed[ch.id]) span.classList.add("completed");
    span.onclick=()=>{ currentIndex=i; loadChallenge(i); };
    listDiv.appendChild(span);
  });
}

// Google Form submission mapping
const formFields = {
  name: "entry.842400589",
  total: "entry.1474438198",
  "1-1": "entry.1260090482",
  "1-2": "entry.326596663",
  "2-1": "entry.862699555",
  "2-2": "entry.955203852",
  "3-1": "entry.2123594613",
  "3-2": "entry.906732008",
  "3-3": "entry.250527701",
  "4-1": "entry.1586645637",
  "4-2": "entry.1024385180",
  "4-3": "entry.382397444"
};

function submitScore(){
  const name = document.getElementById("studentName").value.trim();
  if(!name){ alert("Please enter your name"); return; }

  let params = `${formFields.name}=${encodeURIComponent(name)}&${formFields.total}=${encodeURIComponent(totalPassed()+'/'+totalTests())}`;

  for(let key in formFields){
    if(key.includes("-")){
      const [chId,testId] = key.split("-");
      const arr = testResults[`cases_${chId}`];
      const val = arr && arr[parseInt(testId)-1] ? "Yes":"No";
      params += `&${formFields[key]}=${encodeURIComponent(val)}`;
    }
  }

  const submitURL = `https://docs.google.com/forms/d/e/1FAIpQLScPfAiXDJ-eL-bgpLhekjFPjpEdaRDK0-lE6pFsSohl2mphtQ/formResponse?${params}`;
  fetch(submitURL, { method:"POST", mode:"no-cors" })
    .then(()=>alert("✅ Score submitted successfully!"))
    .catch(()=>alert("❌ Failed to submit score."));
}

loadChallenge(0);
</script>

</body>
</html>
