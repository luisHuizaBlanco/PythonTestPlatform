<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Python Exercise #1</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 40px; }
  h1 { color: #333; }
  code { font-family: Arial, sans-serif; color: #1500ff; font-size: 16px; }
  textarea { width: 100%; height: 180px; font-family: monospace; font-size: 14px; }
  button { background: #007bff; color: white; border: none; padding: 10px 16px; margin: 8px 4px; cursor: pointer; border-radius: 6px; }
  button:hover { background: #0056b3; }
  pre { background: #eee; padding: 8px; border-radius: 6px; }
  #output { margin-top: 20px; font-weight: bold; }
  #progress { margin-bottom: 10px; font-weight: bold; }
  #grade { margin-bottom: 10px; font-weight: bold; color: #007bff; }
  #challengeList { margin-bottom: 15px; }
  .challengeItem { display: inline-block; padding: 5px 10px; margin: 3px; border-radius: 6px; background: #ddd; cursor: pointer; }
  .challengeItem.active { background: #007bff; color: white; }
  .challengeItem.completed { background: #28a745; color: white; }
</style>
</head>
<body>

<h1>Python Exercise #1</h1>

<label>Student Name:
<input type="text" id="studentName" placeholder="Enter your name">
</label>

<h1 id="title">Challenge Title</h1>
<p id="description">Challenge description goes here.</p>

<div id="progress"></div>
<div id="grade"></div>
<div id="challengeList"></div>

<textarea id="code"></textarea><br>

<button onclick="runCode()">Run Tests</button>
<button onclick="prevChallenge()">◀ Previous</button>
<button onclick="nextChallenge()">Next ▶</button>
<button onclick="submitScore()">Submit Final Score</button>

<div id="output"></div>

<script>
let pyodideReady = loadPyodide();

const pythonChallenges = [
  {
    id: 1,
    title: "Math Operators",
    description: "In the function <code>squared(n)</code> below, write code so that it returns square of a number <code>n</code>.<br><br>If you don't know, the square of a number <code>n</code> is <code>n</code> times <code>n</code>.<br><br>To solve this, use: <br>Functions: return <br>Math Operators: +, -, *, /<br><br>Example: <code>squared(2)</code> -> Output: 4",
    starter: "def squared(n):\n    # Your code in the line below\n    pass",
    functionName: "squared",
    tests: [
      { input: [5], expected: 25 },
      { input: [9], expected: 81 }
    ]
  },
  {
    id: 2,
    title: "Reverse the Boolean",
    description: "In the function <code>reverse(bool)</code> that when given boolean <code>bool</code>, returns the opposite value of <code>bool</code>. <br><br> That means, if bool is <code>true</code>, it should return <code>false</code>, and if bool is <code>false</code>, it should return <code>true</code>.<br><br>To solve this, use: <br>Conditionals: if, else <br>Comparison Operators: ==, <, <=<br><br>Example: <code>reverse(true)</code> -> Output: false",
    starter: "def reverse(bool):\n    # Your code in the line below\n    pass",
    functionName: "reverse",
    tests: [
      { input: [true], expected: false },
      { input: [false], expected: true }
    ]
  },
  {
    id: 3,
    title: "Check the Temperature",
    description: "Write a function <code>check_temp(temp)</code> that returns <code>False</code> if the temperature is more than 80 or less than or equal to 70; otherwise it returns <code>True</code>.<br><br>This exercise is all about proper use of conditionals and logical comparison.<br><br>In use here: <br>Conditionals: if, elif, else <br>Comparison Operators: ==, <, <=<br><br>Example: <code>checktemp(90)</code> -> Output: False",
    starter: "def check_temp(temp):\n    # Your code in the line below\n    pass",
    functionName: "check_temp",
    tests: [
      { input: [81], expected: false },
      { input: [70], expected: false },
      { input: [71], expected: true }
    ]
  },
  {
    id: 4,
    title: "Sum from 1 to N",
    description: "Write a function <code>triangular(n)</code> that when given a variable <code>n</code>, returns the sum of the numbers from 1 to <code>n</code>.<br><br>You are going to need to use a loop for this one. If you remember, inside of a loop we have the line <code>let i = 0</code>, this <code>i</code> counts how many loops are made, you can use that to get the sum from 1 to <code>n</code>.<br><br>In use here: <br>Loops: for(let i = 0; i < [number of loops you want]; i++) {}<br>Variable Assignment: =<br>Math Operators: +, -, *, /<br><br>Example: <code>triangular(3)</code> -> Output: 6",
    starter: "def triangular(n):\n    # Your code in the line below\n    pass",
    functionName: "triangular",
    tests: [
      { input: [4], expected: 10 },
      { input: [5], expected: 15 },
      { input: [9], expected: 45 }
    ]
  }
];

let currentIndex=0;
let completed={};
let testResults={};
pythonChallenges.forEach(ch=>testResults[`cases_${ch.id}`]=new Array(ch.tests.length).fill(false));

function totalTests(){ return pythonChallenges.reduce((sum,ch)=>sum+ch.tests.length,0); }
function totalPassed(){ 
  return pythonChallenges.reduce((total,ch)=>{
    const arr = testResults[`cases_${ch.id}`];
    return total + arr.reduce((s,p)=>s+(p?1:0),0);
  },0);
}

function loadChallenge(index){
  const ch = pythonChallenges[index];
  document.getElementById("title").innerHTML = ch.title;
  document.getElementById("description").innerHTML = ch.description;
  document.getElementById("code").value = ch.starter;
  document.getElementById("output").innerHTML = "";
  updateProgress();
  renderChallengeList();
  showVisibleTests(ch);
}

function showVisibleTests(ch){
  const outputDiv=document.getElementById("output");
  let html=`<h3>Test Cases:</h3>`;
  ch.tests.forEach((t,i)=>{
    html+=`<pre>Test ${i+1}: Input: ${JSON.stringify(t.input)} | Expected: ${JSON.stringify(t.expected)}</pre>`;
  });
  outputDiv.innerHTML=html;
}

async function runCode(){
  const pyodide = await pyodideReady;
  const ch = pythonChallenges[currentIndex];
  const code = document.getElementById("code").value;
  const outputDiv = document.getElementById("output");
  outputDiv.innerHTML=`<h3>Test Results:</h3>`;

  let passedCount=0;
  let caseResults=[];

  try{
    await pyodide.runPythonAsync(code);
    for(let i=0;i<ch.tests.length;i++){
      const t = ch.tests[i];
      const pyArg = v => {
        if (v === true) return "True";
        if (v === false) return "False";
        return v;
      };
      const args = t.input.map(pyArg).join(", ");
      const result = pyodide.runPython(`${ch.functionName}(${args})`);
      const pass = result === t.expected;
      caseResults[i] = pass;
      if(pass) passedCount++;
      outputDiv.innerHTML += `<pre style="color:${pass?'green':'red'}">
        Test ${i+1}: ${t.input.join(', ')} ➜ ${result} (${pass?'✅ Passed':'❌ Expected '+t.expected})
      </pre>`;
    }

    testResults[ch.id] = passedCount;
    testResults[`cases_${ch.id}`] = caseResults;
    if(passedCount===ch.tests.length) completed[ch.id]=true; else delete completed[ch.id];

    outputDiv.innerHTML += `<p><strong>${passedCount} / ${ch.tests.length} tests passed.</strong></p>`;
    updateProgress();
    renderChallengeList();
  }catch(err){
    outputDiv.innerHTML=`<pre style="color:red;">${err}</pre>`;
  }
}

function nextChallenge(){ currentIndex=(currentIndex+1)%pythonChallenges.length; loadChallenge(currentIndex); }
function prevChallenge(){ currentIndex=(currentIndex-1+pythonChallenges.length)%pythonChallenges.length; loadChallenge(currentIndex); }

function updateProgress(){
  const doneCount = Object.keys(completed).length;
  const total = pythonChallenges.length;
  document.getElementById("progress").innerText=`Challenges Completed: ${doneCount} / ${total}`;
  document.getElementById("grade").innerText=`Total Grade: ${totalPassed()} / ${totalTests()} tests passed`;
}

function renderChallengeList(){
  const listDiv=document.getElementById("challengeList");
  listDiv.innerHTML="";
  pythonChallenges.forEach((ch,i)=>{
    const span=document.createElement("span");
    span.innerText=ch.title;
    span.className="challengeItem";
    if(i===currentIndex) span.classList.add("active");
    if(completed[ch.id]) span.classList.add("completed");
    span.onclick=()=>{ currentIndex=i; loadChallenge(i); };
    listDiv.appendChild(span);
  });
}

// Google Form submission mapping
const formFields = {
  name: "entry.842400589",
  total: "entry.1474438198",
  "1-1": "entry.1260090482",
  "1-2": "entry.326596663",
  "2-1": "entry.862699555",
  "2-2": "entry.955203852",
  "3-1": "entry.2123594613",
  "3-2": "entry.906732008",
  "3-3": "entry.250527701",
  "4-1": "entry.1586645637",
  "4-2": "entry.1024385180",
  "4-3": "entry.382397444"
};

function submitScore(){
  const name = document.getElementById("studentName").value.trim();
  if(!name){ alert("Please enter your name"); return; }

  let params = `${formFields.name}=${encodeURIComponent(name)}&${formFields.total}=${encodeURIComponent(totalPassed()+'/'+totalTests())}`;

  for(let key in formFields){
    if(key.includes("-")){
      const [chId,testId] = key.split("-");
      const arr = testResults[`cases_${chId}`];
      const val = arr && arr[parseInt(testId)-1] ? "Yes":"No";
      params += `&${formFields[key]}=${encodeURIComponent(val)}`;
    }
  }

  const submitURL = `https://docs.google.com/forms/d/e/1FAIpQLScPfAiXDJ-eL-bgpLhekjFPjpEdaRDK0-lE6pFsSohl2mphtQ/formResponse?${params}`;
  fetch(submitURL, { method:"POST", mode:"no-cors" })
    .then(()=>alert("✅ Score submitted successfully!"))
    .catch(()=>alert("❌ Failed to submit score."));
}

loadChallenge(0);
</script>

</body>
</html>
